<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="1BWHOhCt_eijp5wvU_9Cvh591AfMs_im4cOLhN3wkP4"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Hồi quy Softmax hay Tôi đã tốn một buổi chiều thứ Tư như thế nào? | The-Anh Vu-Le (Nah)</title> <meta name="author" content="The-Anh Vu-Le"> <meta name="description" content="a fake trying to be real "> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%90%96&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://vltanh.github.io//blog/2021/hoi-quy-softmax/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Hồi quy Softmax hay Tôi đã tốn một buổi chiều thứ Tư như thế nào?",
      "description": "",
      "published": "June 16, 2021",
      "authors": [
        {
          "author": "The-Anh Vu-Le",
          "authorURL": "",
          "affiliations": [
            {
              "name": "",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">The-Anh Vu-Le (Nah)</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Hồi quy Softmax hay Tôi đã tốn một buổi chiều thứ Tư như thế nào?</h1> <p></p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#b%C3%A0i-to%C3%A1n-ph%C3%A2n-l%E1%BB%9Bp-%C4%91%C6%A1n-nh%C3%A3n">Bài toán Phân lớp Đơn nhãn</a></div> <div><a href="#m%C3%B4-h%C3%ACnh-h%E1%BB%93i-quy-softmax">Mô hình Hồi quy Softmax</a></div> <div><a href="#%C3%A1p-d%E1%BB%A5ng">Áp dụng</a></div> <div><a href="#c%C3%A0i-%C4%91%E1%BA%B7t">Cài đặt</a></div> <ul> <li><a href="#h%C6%B0%E1%BB%9Bng-xu%C3%B4i">Hướng xuôi</a></li> <li><a href="#h%C6%B0%E1%BB%9Bng-ng%C6%B0%E1%BB%A3c">Hướng ngược</a></li> </ul> </nav> </d-contents> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Miễn trừ trách nhiêm:
- Có thể sai (vì mình ngu)
- Có thể không tốt (lý do như trên)
</code></pre></div></div> <h2 id="bài-toán-phân-lớp-đơn-nhãn">Bài toán Phân lớp Đơn nhãn</h2> <p>Cho một bộ dữ liệu \(\mathcal{D}\) là tập hợp \(N\) điểm dữ liệu \((\mathbf{x}^{(i)}, y^{(i)})\) trong đó \(\mathbf{x}^{(i)} = (x^{(i)}_1, x^{(i)}_2, ..., x^{(i)}_D)^T \in \mathbb{R}^D\) là đầu vào và \(y^{(i)} \in \{1, 2,..., C\}\) là nhãn phân lớp đối với điểm dữ liệu thứ \(i=1..N\). Ta mong muốn xây dựng một mô hình phân lớp dựa trên bộ dữ liệu đã cho.</p> <h2 id="mô-hình-hồi-quy-softmax">Mô hình Hồi quy Softmax</h2> <p><strong>Mô hình Hồi quy Softmax</strong> có tham số là một ma trận trọng số thực \(\mathbf{W} = (w_{i,j}) \in \mathbb{R}^{C \times (D+1)}\). Đối với một điểm dữ liệu đầu vào \(\mathbf{x} \in \mathbb{R}^D\), nó đưa ra dự đoán thông qua các bước như sau:</p> <ol> <li>Thêm giá trị hằng \(x_0 = 1\) vào \(\mathbf{x}\) để tạo thành đầu vào mới \(\mathbf{x'} := (1, x_1, x_2, ..., x_D)^T\).</li> <li>Tính \(\mathbf{z} = \mathbf{W} \mathbf{x'}\). Nhận thấy \(\mathbf{z} = (z_1, z_2, ..., z_C)^T \in \mathbb{R}^C\).</li> <li>Tính \(\mathbf{h} = \sigma(\mathbf{z}) = (h_1, h_2, ..., h_C)^T\) với</li> </ol> \[h_i = \dfrac{e^{z_1}}{\sum_{k=1}^{C}e^{z_k}}, i = 1..C\] <p>Hàm \(\sigma\) được gọi là <strong>hàm softmax</strong>. Có thể thấy, ở đây, nó ánh xạ từ \(\mathbb{R}^C \to [0, 1]^C\).</p> <p>Ta mong muốn tìm được \(\mathbf{W}\) để \(h_c\) xấp xỉ xác suất đầu vào \(\mathbf{x}\) thuộc vào lớp \(c\).</p> <h2 id="áp-dụng">Áp dụng</h2> <p>Để làm được điều này, ta đưa nó về bài toán tìm \(\mathbf{W}\) để tối thiểu hàm lỗi \(\mathcal{L}(\mathcal{D}, \mathbf{W})\). Hàm lỗi được chọn ở đây là</p> \[\mathcal{L}(\mathcal{D}, \mathbf{W}) = \dfrac{1}{N} \sum_{n=1}^{N} \left( -\log h_{y^{(n)}}^{(n)} \right)\] <p>Ta giải quyết nó bằng giải thuật Gradient Descent. Do đó, ta cần tìm được đạo hàm hàm lỗi đối với mỗi tham số (các giá trị \(w_{i,j}\) trong ma trận trọng số \(\mathbf{W}\)).</p> <p>Trước tiên, cần nói qua về đạo hàm của hàm softmax, cụ thể là đạo hàm của phần tử thứ \(i\) trong vector kết quả, đối với phần tử thứ \(j\) trong vector đầu vào:</p> \[\dfrac{\partial}{\partial z_j} h_i = \dfrac{\partial}{\partial z_j} \dfrac{e^{\mathbf{z}_i}}{\sum_{k=1}^{n} e^{\mathbf{z}_k}} = \dfrac{1}{\left(\sum_{k=1}^{n} e^{\mathbf{z}_k} \right)^2} \left[ \left( \dfrac{\partial}{\partial z_j} e^{\mathbf{z}_i} \right) \left( \sum_{k=1}^{n} e^{\mathbf{z}_k} \right ) - e^{\mathbf{z}_i} \dfrac{\partial}{\partial z_j} \left( \sum_{k=1}^{n} e^{\mathbf{z}_k} \right ) \right]\] <p>Định nghĩa \(\delta_{i, j} = 1\) khi \(i = j\) và bằng \(0\) trong trường hợp khác, ta có</p> \[\dfrac{\partial}{\partial z_j} h_i = \dfrac{1}{\left(\sum_{k=1}^{n} e^{\mathbf{z}_k} \right)^2} \left[ \delta_{i, j} e^{z_i} \left( \sum_{k=1}^{n} e^{\mathbf{z}_k} \right ) - e^{\mathbf{z}_i} e^{\mathbf{z}_j} \right] = \dfrac{e^{z_i}}{\sum_{k=1}^{n} e^{\mathbf{z}_k}} \left[ \delta_{i, j} - \dfrac{e^{z_j}}{\sum_{k=1}^{n} e^{\mathbf{z}_k}} \right]\] <p>Như vậy,</p> \[\dfrac{\partial}{\partial z_j} h_i = h_i (\delta_{i, j} - h_j)\] <p>Từ đó, ta có thể tính được</p> \[\dfrac{\partial}{\partial w_{i,j}} \mathcal{L}(\mathcal{D}, \mathbf{W}) = \dfrac{1}{N} \sum_{n=1}^{N} - \dfrac{\partial}{\partial w_{i,j}} \log h_{y^{(n)}}^{(n)} = \dfrac{1}{N} \sum_{n=1}^{N} - \dfrac{1}{h_{y^{(n)}}^{(n)}} \dfrac{\partial h_{y^{(n)}}^{(n)}}{\partial w_{i,j}}\] <p>Sử dụng quy tắc mắt xích, ta có</p> \[\dfrac{\partial}{\partial w_{i,j}} \mathcal{L}(\mathcal{D}, \mathbf{W}) = \dfrac{1}{N} \sum_{n=1}^{N} \left[ - \dfrac{1}{h_{y^{(n)}}^{(n)}} \sum_{k=1}^{C} \dfrac{\partial h_{y^{(n)}}^{(n)}}{\partial z^{(n)}_k} \dfrac{\partial z^{(n)}_k}{\partial w_{i,j}} \right] = \dfrac{1}{N} \sum_{n=1}^{N} \left[ - \sum_{k=1}^{C} (\delta_{y^{(n)}, k} - h^{(n)}_k) \dfrac{\partial z^{(n)}_k}{\partial w_{i,j}} \right]\] <p>Vì \(z^{(n)}\_k = \sum_{t=1}^{D} w_{k, t} x^{(n)}_t\) nên</p> \[\dfrac{\partial}{\partial w_{i,j}} \mathcal{L}(\mathcal{D}, \mathbf{W}) = \dfrac{1}{N} \sum_{n=1}^{N} \left[ - \sum_{k=1}^{C} (\delta_{y^{(n)}, k} - h^{(n)}_k) \delta_{k, i} x^{(n)}_j \right] = \dfrac{1}{N} \sum_{n=1}^{N} - (\delta_{y^{(n)}, i} - h^{(n)}_i) x^{(n)}_j\] <p>Như vậy, để giải quyết bài toán tìm \(\mathbf{W}\) để tối thiểu \(\mathcal{L}(\mathcal{D}, \mathbf{W})\), ta có thể áp dụng giải thuật Gradient Descent với</p> \[\dfrac{\partial}{\partial w_{i,j}} \mathcal{L}(\mathcal{D}, \mathbf{W}) = \dfrac{1}{N} \sum_{n=1}^{N} - (\delta_{y^{(n)}, i} - h^{(n)}_i) x^{(n)}_j\] <h2 id="cài-đặt">Cài đặt</h2> <h3 id="hướng-xuôi">Hướng xuôi</h3> <p>Có:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>X: (D, N)
y: (N,)
W: (C, D+1)
</code></pre></div></div> <p>Thêm giá trị hằng</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X_</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">((</span><span class="n">D</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>    <span class="c1"># X_: (D+1, N)
</span><span class="n">X_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">X</span>
</code></pre></div></div> <p>Đưa ra dự đoán</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">z</span> <span class="o">=</span> <span class="n">W</span> <span class="o">@</span> <span class="n">X_</span>                <span class="c1"># z: (C, N)
</span><span class="n">h</span> <span class="o">=</span> <span class="nf">softmax</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># h: (C, N)  
</span></code></pre></div></div> <h3 id="hướng-ngược">Hướng ngược</h3> <p>Ta muốn tìm ma trận <code class="language-plaintext highlighter-rouge">dW</code> bằng numpy sao cho phần tử tại vị trí \((i, j)\) của ma trận này bằng giá trị đạo hàm của hàm lỗi so với \(w_{i, j}\), dựa trên công thức</p> \[\dfrac{\partial}{\partial w_{i,j}} \mathcal{L}(\mathcal{D}, \mathbf{W}) = \dfrac{1}{N} \sum_{n=1}^{N} - (\delta_{y^{(n)}, i} - h^{(n)}_i) x^{(n)}_j\] <h4 id="cách-1">Cách 1</h4> <p>Một cách cài đặt ngây ngô là</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dW</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>     <span class="c1"># dW: (N, C, D+1)
</span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">D</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">dW</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">-</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span> <span class="o">*</span> <span class="n">X_</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
<span class="n">dW</span> <span class="o">=</span> <span class="n">dW</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># dW: (C, D+1)
</span></code></pre></div></div> <h4 id="cách-2">Cách 2</h4> <p>Cải tiến đơn giản để hạn chế vòng lặp <code class="language-plaintext highlighter-rouge">n</code>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dW</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>    <span class="c1"># dW: (C, D+1)
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">D</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dW</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(((</span><span class="n">i</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">X_</span><span class="p">[</span><span class="n">j</span><span class="p">]).</span><span class="nf">mean</span><span class="p">()</span>
</code></pre></div></div> <h4 id="cách-3">Cách 3</h4> <p>Nhận thấy dòng <code class="language-plaintext highlighter-rouge">4</code> có thể tách làm 2 bước</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dW</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">X_</span><span class="p">[</span><span class="n">j</span><span class="p">]).</span><span class="nf">mean</span><span class="p">()</span>      <span class="c1"># (1)
</span>
<span class="n">dW</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">*</span> <span class="n">X_</span><span class="p">[</span><span class="n">j</span><span class="p">]).</span><span class="nf">mean</span><span class="p">()</span>      <span class="c1"># (2)
</span></code></pre></div></div> <p>Công thức <code class="language-plaintext highlighter-rouge">(2)</code> cho thấy <code class="language-plaintext highlighter-rouge">dW[i, j]</code> chỉ đơn giản là tích vô hướng (chia <code class="language-plaintext highlighter-rouge">N</code>) của <code class="language-plaintext highlighter-rouge">h[i]</code> và <code class="language-plaintext highlighter-rouge">X_[j]</code>. Nói cách khác, hoàn toàn có thể rút gọn lại thành</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dW</span> <span class="o">=</span> <span class="n">h</span> <span class="o">@</span> <span class="n">X_</span><span class="p">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">N</span>        <span class="c1"># (C, N) x (N, D+1) =&gt; (C, D+1)
</span></code></pre></div></div> <p>Đoạn mã bây giờ nhìn như thế này, thật ra thì cũng chẳng hơn cái trên là bao vì kiểu gì cũng 2 vòng lặp, chỉ là bỏ bớt tính toán tí.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dW</span> <span class="o">=</span> <span class="n">h</span> <span class="o">@</span> <span class="n">X_</span><span class="p">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">N</span>    <span class="c1"># dW: (C, D+1)
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">D</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dW</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">X_</span><span class="p">[</span><span class="n">j</span><span class="p">]).</span><span class="nf">mean</span><span class="p">()</span>
</code></pre></div></div> <p>Nhìn vào đoạn mã, có thể nhận xét là với mỗi giá trị của <code class="language-plaintext highlighter-rouge">i</code> thì (1) chỉ có dòng thứ <code class="language-plaintext highlighter-rouge">i</code> của <code class="language-plaintext highlighter-rouge">dW</code> được cập nhật; và (2) cập nhật bằng cách trừ đi một lượng bằng vector trung bình của các điểm trong tập dữ liệu mà thuộc lớp <code class="language-plaintext highlighter-rouge">i</code>.</p> <p>Đúng theo suy nghĩ này, có thể viết lại:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dW</span> <span class="o">=</span> <span class="n">h</span> <span class="o">@</span> <span class="n">X_</span><span class="p">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">N</span>    <span class="c1"># dW: (C, D+1)
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
    <span class="n">dW</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">X_</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">==</span> <span class="n">y</span><span class="p">].</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
</code></pre></div></div> <p>Lưu ý thay vì <code class="language-plaintext highlighter-rouge">.mean()</code> thì phải thay bằng <code class="language-plaintext highlighter-rouge">.sum() / N</code> vì việc slice cột theo điều kiện <code class="language-plaintext highlighter-rouge">i == y</code> đã làm giảm số lượng cột trong <code class="language-plaintext highlighter-rouge">X_</code>.</p> <h4 id="cách-4">Cách 4</h4> <p>Thực tế thì đến đây code đã chạy nhanh hơn hẳn rồi (chắc phải gấp 10 lần cái 3 vòng for ban đầu). Nhưng mà tại lỡ rồi làm cho tới chứ (với không benchmark kỹ nên ai biết được).</p> <p>Cũng cùng ý tưởng trên, bây giờ mình cần một ma trận, gọi là <code class="language-plaintext highlighter-rouge">M</code> đi, có <code class="language-plaintext highlighter-rouge">C</code> dòng sao cho dòng <code class="language-plaintext highlighter-rouge">c</code> là tổng các vector (chuyển vị) của các điểm dữ liệu thuộc lớp <code class="language-plaintext highlighter-rouge">c</code>. Nói cách khác, mình đang tìm cách để chọn ra các dòng trong <code class="language-plaintext highlighter-rouge">X_.T</code> để cộng lại thành các dòng trong <code class="language-plaintext highlighter-rouge">M</code>.</p> <p>Nếu mà bạn học đại số tuyến tính và giáo viên của bạn cũng ổn áp như Gilbert Strang (hoặc bạn tự đọc gì đấy) thì chắc là các bạn đã biết phép nhân ma trận \(EF\) sẽ tạo ra ma trận \(G\) sao cho dòng thứ \(c\) của nó là tổ hợp tuyến tính của các dòng của $F$ với hệ số là các phần tử của dòng thứ \(c\) của \(E\).</p> <p>Nghe có liên quan rồi chứ? Nếu <code class="language-plaintext highlighter-rouge">X_.T</code> của mình là \(F\) trong nhận xét trên thì \(G\) sẽ là <code class="language-plaintext highlighter-rouge">M</code> mình cần tìm. Vậy thì \(E\) là gì? \(E\) sẽ là ma trận nhị phân nhằm “chọn ra” các dòng, như vậy \(e_{c, i} = 1\) khi mình muốn chọn dòng <code class="language-plaintext highlighter-rouge">i</code> trong <code class="language-plaintext highlighter-rouge">X_.T</code> để thêm nó vào dòng <code class="language-plaintext highlighter-rouge">c</code> trong <code class="language-plaintext highlighter-rouge">M</code>. Nói cách khác, \(e_{c, i} = 1\) khi điểm dữ liệu thứ \(i\) của mình thuộc lớp \(c\). Vậy \(E\) không đâu khác chính là ma trận one-hot encoding!</p> <p>Tìm trên Google sẽ thấy cách tạo ma trận one-hot encoding khá đơn giản</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="c1"># I: (C, C)
</span><span class="n">E</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">y</span><span class="p">].</span><span class="n">T</span>    <span class="c1"># E: (C, N)
</span></code></pre></div></div> <p>Một cách hiểu đơn giản là <code class="language-plaintext highlighter-rouge">E</code> được tạo thành bằng cách lần lượt lấy từng dòng của ma trận đơn vị <code class="language-plaintext highlighter-rouge">I</code>, dòng được lấy thứ <code class="language-plaintext highlighter-rouge">i</code> là <code class="language-plaintext highlighter-rouge">y[i]</code>.</p> <p>Như vậy ta có thể tính được</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">M</span> <span class="o">=</span> <span class="n">E</span> <span class="o">@</span> <span class="n">X_</span><span class="p">.</span><span class="n">T</span>    <span class="c1"># M: (C, D+1)
</span></code></pre></div></div> <p>Tổng hợp lại, ta có mã nguồn cuối cùng:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dW</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="n">C</span><span class="p">)[</span><span class="n">y</span><span class="p">].</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="n">X_</span><span class="p">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">N</span>    <span class="c1"># dW: (C, D+1)
</span></code></pre></div></div> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"vltanh/vltanh.github.io","data-repo-id":"R_kgDOIk7rUA","data-category":"Comments","data-category-id":"DIC_kwDOIk7rUM4CTV2c","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 The-Anh Vu-Le. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-JS11DTCF4Y"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JS11DTCF4Y");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>